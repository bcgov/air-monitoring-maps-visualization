<!DOCTYPE html>
<html>
  <head>
    <base target="_parent">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta http-equiv="Cache-control" content="no-cache">
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="-1" />
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no"/>
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<meta name="HandheldFriendly" content="true" />
    <meta name="description" content="View current PM2.5 Data in full screen." />
    <title>PM2.5 Data - Province of British Columbia</title>
    <link rel="stylesheet" href="https://js.arcgis.com/3.19/esri/css/esri.css">
	<link rel="stylesheet" href="https://js.arcgis.com/3.20/dijit/themes/claro/claro.css" />
	<!-- <link rel="stylesheet" href="../../templates-env/css/env-main.css" /> -->
	
     <style>
html, body {
      height: 100%; /* used for height of overall map page */
      width: 100%; /* used for width of overall map page */
      margin: 0;
      padding: 0;
	  overflow: hidden;
	  

    }
	
	#map {
      height: 100%; /* used for actual height of map */
      width: 75%; /* used for actual width of map taking into account left pane width*/
      margin: 0;
      padding: 0;
	  overflow: hidden;
	  border: solid 0.5px black;
	  border-left: none;
  
    }
	  
	 #HomeButton {
      position: absolute;
      top: 95px;
      left: 20px;
      z-index: 30;
    }
 
    #leftPane {
      width: 25%;
      height: auto;
      margin: 0;
	  border: solid 0.5px black;
	  font-family: Myriad-Pro, Calibri, Arial, "sans serif";

    }

    .nav {
      padding: 5px 10px;
      border: solid 1px grey;
    }
    
    #header {
      text-align: center; 
      height: 65px;
      border-bottom: none;
	  font-family: Myriad-Pro, Calibri, Arial, "sans serif";
	  border-top: solid 0.5px black;
	  border-left: solid 0.5px black;
	  border-right: solid 0.5px black;
      
    }
	
	#legend {
      text-align: left;
      height: 10%;
	  padding: 0;
	  margin: 5;
      border-bottom: solid 0.5px black;
	  font-family: Myriad-Pro, Calibri, Arial, "sans serif";
	  display: none;    
	  border-left: solid 0.5px black;
	  border-right: solid 0.5px black;	
    }
	
        table td {
            
            padding: 5px;
    text-align: center;
}
            
	
	.moreInfo ul {
    list-style-type: none;
    padding-left: 0;
    margin-top: 5px;    
}
        
    .moreInfo ul > li {
    background: transparent url("http://www.env.gov.bc.ca/epd/templates-env/images/bullet.png") no-repeat scroll 0 8px;
    margin-bottom: 3px;
    padding-left: 15px;
}    
        
        
    </style>
	
       <!-- <script src="https://js.arcgis.com/3.19/"></script> -->
    <script type="text/javascript" src="custom/js/arc-map/esri-init.js"></script>
	<script type="text/javascript" src="custom/js/arc-map/init.js"></script>
	<script type="text/javascript" src="custom/js/arc-map/labels_stations.js"></script>
	
	
    <script>   	  

      require([
        "esri/map", 
		"esri/dijit/HomeButton",
        "esri/layers/CSVLayer",
		"esri/layers/GraphicsLayer",
		"esri/layers/FeatureLayer",
		"esri/layers/KMLLayer",
        "esri/Color",
		"esri/graphic",
        "esri/symbols/SimpleMarkerSymbol",
		"esri/symbols/TextSymbol",
		"esri/symbols/Font",
        "esri/renderers/ClassBreaksRenderer",
		"esri/renderers/SimpleRenderer",
        "esri/renderers/UniqueValueRenderer",
        "esri/InfoTemplate",
		"esri/dijit/PopupTemplate",
		"esri/dijit/Popup",
		"dijit/layout/BorderContainer",
		"dijit/layout/ContentPane",
        "esri/urlUtils",
		"esri/geometry/Polygon",
		"esri/geometry/Point",
		"esri/symbols/SimpleFillSymbol",
        "esri/symbols/SimpleLineSymbol",
		"dojo/ready",
		"dojo/on",
		"dojo/_base/connect",
		"dojo/dom",
		"dijit/registry",
		"dojo/dom-construct",
		"dojo/parser",
		"esri/domUtils",
		"esri/arcgis/utils"

		], function(
        Map, HomeButton, CSVLayer, GraphicsLayer, FeatureLayer, KMLLayer, Color, Graphic, SimpleMarkerSymbol, TextSymbol, Font, ClassBreaksRenderer, SimpleRenderer, UniqueValueRenderer, InfoTemplate, PopupTemplate, Popup, BorderContainer, ContentPane, urlUtils, Polygon, Point, SimpleFillSymbol, SimpleLineSymbol, ready, on, connect, dom, registry, domConstruct, parser, domUtils, arcgisUtils

      ) 
      
      {
		
	parser.parse();

        //setup event handlers for the next/previous buttons
        on(dom.byId("previous"), "click", selectPrevious);
        on(dom.byId("next"), "click", selectNext);	
		
	var home = new HomeButton({
     map: map
      }, "HomeButton");
      home.startup();
	  
	map.infoWindow.set("popupWindow", false);
    initializeSidebar(window.map);
	  

	var symbol = new SimpleMarkerSymbol({
		"color": null,
		"size": 10,
		"xoffset": 0,
		"yoffset": 0,
		"type": "esriSMS",
		"style": "esriSMSCircle",
		"outline": {
			"color": [0,0,0],
			"width": 1.0,
			"type": "esriSLS",
			"style": "esriSLSSolid"
		}
	});

	var renderer = new ClassBreaksRenderer(symbol, "PM25");
	
    renderer.addBreak({
		minValue: 500,
		maxValue: Infinity,
		label: ">500 +",
		symbol: new SimpleMarkerSymbol(symbol).setColor(new Color("#660000")).setSize(13)
          
        });      

	renderer.addBreak({
		minValue: 250,
		maxValue: 500,
		label: ">250-500",
		symbol: new SimpleMarkerSymbol(symbol).setColor(new Color("#990000")).setSize(13)
          
        });
		
	renderer.addBreak({
		minValue: 100,
		maxValue: 250,
		label: ">100-250",
		symbol: new SimpleMarkerSymbol(symbol).setColor(new Color("#cc0000")).setSize(13)
          
        });	
	renderer.addBreak({
		minValue: 80,
		maxValue: 100,
		label: ">80-100",
		symbol: new SimpleMarkerSymbol(symbol).setColor(new Color("#ff0000")).setSize(13)
          
        });
		
	renderer.addBreak({
		minValue: 60,
		maxValue: 80,
		label: ">60-80",
		symbol: new SimpleMarkerSymbol(symbol).setColor(new Color("#ff6666")).setSize(13)
          
        });

        renderer.addBreak({
		minValue: 40,
		maxValue: 60,
		label: ">40-60",
		symbol: new SimpleMarkerSymbol(symbol).setColor(new Color("#ff9933")).setSize(13)
          
        });	

          
    renderer.addBreak({
		minValue: 25,
		maxValue: 40,
		label: ">25-40",
		symbol: new SimpleMarkerSymbol(symbol).setColor(new Color("#ffff00")).setSize(13)
          
        });	
	
    renderer.addBreak({
		minValue: 15,
		maxValue: 25,
		label: ">15-25",
		symbol: new SimpleMarkerSymbol(symbol).setColor(new Color("#A18A14")).setSize(13)
          
        });		
		
	renderer.addBreak({
		minValue: 5,
		maxValue: 15,
		label: ">5-15",
		symbol: new SimpleMarkerSymbol(symbol).setColor(new Color("#0099cc")).setSize(13)
          
        });
		
	renderer.addBreak({
		minValue: 0,
		maxValue: 5,
		label: "0-5",
		symbol: new SimpleMarkerSymbol(symbol).setColor(new Color("#00ccff")).setSize(13)
          
        });

	renderer.defaultLabel= "No PM 2.5 Data";
		
	var csvair = new CSVLayer("../aqo/csv/bc_air_monitoring_stations.csv", {});

	csvair.setRenderer(renderer);
	
	var infoTemplate = new InfoTemplate();
	
	infoTemplate.setTitle("Station Summary");
	
	infoTemplate.setContent(generateInfoContent);
	
	function generateInfoContent(graphic){

		var formatString = "";  
	
		var datetest = graphic.attributes.DATE
	
		var pm25Test = graphic.attributes.PM25;
	 
		var pm25Test24 = graphic.attributes.PM25_24;
		
		var dirTest = graphic.attributes.WDIR_VEC;
	
		var spdTest = graphic.attributes.WSPD_VEC;
	
		var tempTest = graphic.attributes.TEMP;
	
		var humTest = graphic.attributes.HUMIDITY;
		
		var barTest = graphic.attributes.BAR_PRESSURE;
		
		var precipTest = graphic.attributes.PRECIPITATION;
		
		var snowTest = graphic.attributes.SNOWDEPTH;

		var footertest = graphic.attributes.SERIAL_CODE;
        
        var linktest = graphic.attributes.SERIAL_CODE;

		formatString = "<div style='font-size:1.2em;font-weight:bold;'>"+graphic.attributes.STATION_NAME+"</div>";
	
		if (pm25Test && pm25Test || pm25Test24 && pm25Test24 || dirTest && dirTest || spdTest && spdTest || tempTest && tempTest|| precipTest && precipTest|| snowTest && snowTest|| humTest && humTest !== '' ) {
			formatString += "<div style='font-size:.8em;margin-bottom:5px;'>As of: "+graphic.attributes.DATE+"</div>";
		}
        
        if (linktest && linktest !== '' ) {
		formatString += "<div style='font-size:.8em;margin-bottom:5px;'><a href=http://www.env.gov.bc.ca/epd/bcairquality/data/station.html?id="+graphic.attributes.EMS_ID+">Graphs</a> | "+"<a href="+graphic.attributes.URL+">Download Data</a></div><hr/>";
		}
		
		if (pm25Test && pm25Test || pm25Test24 && pm25Test24 !== '' ) {
		formatString += "<div class='moreInfo'><strong>PM<sub>2.5</sub> Data:</strong><ul>";
		}
  
		
		if (pm25Test && pm25Test !== ''){
			formatString += "<li>PM<sub>2.5</sub> (1h): <strong>" + graphic.attributes.PM25+"</strong> µg/m<sup>3</sup></li>";
		}
  
        if (pm25Test24 && pm25Test24 >=25){
		formatString += "<li>PM<sub>2.5</sub> (24h): <strong>" + "<font color=#ff0000> "+ graphic.attributes.PM25_24+"</strong> µg/m<sup>3</sup></font>.<br/><font color=#8c8c8c>Objective: 25 µg/m<sup>3</sup></font></li>";
		}
		
		if (pm25Test24 && pm25Test24 < 25){
		formatString += "<li>PM<sub>2.5</sub>(24h): <strong>" + graphic.attributes.PM25_24+"</strong> µg/m<sup>3</sup>. <br /><font color=#8c8c8c>Objective<sup>*</sup>: 25 µg/m<sup>3</sup></font></li>";
		}
        
        if (pm25Test && pm25Test || pm25Test24 && pm25Test24 !== '' ) {
		formatString += "</ul></div>";
		}
        
        
        if (dirTest && dirTest || spdTest && spdTest || tempTest && tempTest|| precipTest && precipTest|| snowTest && snowTest|| humTest && humTest!==''){
		formatString += "<div class='moreInfo'><strong>Meteorological Data:</strong><ul>";
		}
  
		if (dirTest && dirTest !== '' ) {
		formatString += "<li>Wind Direction: <strong>" + graphic.attributes.WDIR_VEC+"</strong>°</li>";
		}
  
		if (spdTest && spdTest !== '' ) {
		formatString += "<li>Wind Speed: <strong>" + graphic.attributes.WSPD_VEC+"</strong> "+graphic.attributes.WSPD_UNIT+"</li>";
		}
  
		if (tempTest && tempTest !== '' ) {
		formatString += "<li>Temperature: <strong>" + graphic.attributes.TEMP+"</strong> °C</li>";
		}
  
		if (humTest && humTest !== '' ) {
		formatString += "<li>Humidity: <strong>" + graphic.attributes.HUMIDITY+"</strong>%</li>";
		}
		
		if (barTest && barTest !== '' ) {
		formatString += "<li>Barometric Pressure: <strong>" + graphic.attributes.BAR_PRESSURE+"</strong> "+graphic.attributes.PRESSURE_UNIT+"</li>";
		}
		
		if (precipTest && precipTest !== '' ) {
		formatString += "<li>Precipitation: <strong>" + graphic.attributes.PRECIPITATION+"</strong> "+graphic.attributes.PRECIPITATION_UNIT+"</li>";
		}
		
		if (snowTest && snowTest !== '' ) {
		formatString += "<li>Snow Depth: <strong>" + graphic.attributes.SNOWDEPTH+"</strong> "+graphic.attributes.SNOWDEPTH_UNIT+"</li>";
		}
        
        if (dirTest && dirTest || spdTest && spdTest || tempTest && tempTest|| precipTest && precipTest|| snowTest && snowTest|| humTest && humTest!==''){
		formatString += "</ul></div>";
		}
  
		if (footertest && footertest !== '' ) {
		formatString += "<div></div>"
		}
        
        if (pm25Test && pm25Test || pm25Test24 && pm25Test24 !== '' ) {
		formatString += "<small><sup>*</sup>Air Quality Objective for PM<sub>2.5</sub> is <strong>25 µg/m<sup>3</sup></strong> when averaged over a <strong>24 hour period</strong>.</small>";
		}
		
		//Disclaimer in the map pop-up side panel
		formatString  += "<p><strong><small>Please note that air quality data may be missing for many reasons that are beyond our control including local power or communications outages, instrument calibration cycles or failure.</small></strong></p>"  

    return formatString; 

	}  	
			
	csvair.setInfoTemplate(infoTemplate);
	map.addLayer(csvair);
	var refresh=5;
	csvair.setRefreshInterval(refresh);
	function initializeSidebar(map) {
          var popup = map.infoWindow;

          //when the selection changes update the side panel to display the popup info for the 
          //currently selected feature. 
          connect.connect(popup, "onSelectionChange", function() {
            displayPopupContent(popup.getSelectedFeature());
          });

          //when the selection is cleared remove the popup content from the side panel. 
          connect.connect(popup, "onClearFeatures", function() {
            //dom.byId replaces dojo.byId
            dom.byId("featureCount").innerHTML = "<strong>Select a station on the map.</strong>";
            //registry.byId replaces dijit.byId
            registry.byId("leftPane").set("content", "");
            domUtils.hide(dom.byId("pager"));
          });

          //When features are associated with the map's info window update the sidebar with the new content. 
          connect.connect(popup, "onSetFeatures", function() {
            displayPopupContent(popup.getSelectedFeature());
            if (popup.features.length > 1) {
              dom.byId("featureCount").innerHTML = "<strong>" + popup.features.length + " stations selected.</strong>";
              //enable navigation if more than one feature is selected 
              domUtils.show(dom.byId("pager"))
            } else {
              dom.byId("featureCount").innerHTML = "<strong>" + popup.features.length + " station selected.</strong>";
              domUtils.hide(dom.byId("pager"));
            }
          });
        }

        function displayPopupContent(feature) {
          if (feature) {
            var content = feature.getContent();
            registry.byId("leftPane").set("content", content);
          }
        }

        function selectPrevious() {
          window.map.infoWindow.selectPrevious();
        }

        function selectNext() {
          window.map.infoWindow.selectNext();
        }
		
 });
    </script>
    
    
    
  </head>

 <body class="claro">
  <div id="mainWindow" data-dojo-type="dijit/layout/BorderContainer" 
    data-dojo-props="design:'headline',gutters:false" 
    style="width:100%; height:100%;" >
    <!-- start left content --> 
    
    <div data-dojo-type="dijit/layout/BorderContainer" data-dojo-props="gutters:false" 
      region="left" style="width: 25%;height:100%;">
      <div id="leftPane" data-dojo-type="dijit/layout/ContentPane" 
        data-dojo-props="region:'center'"></div>
	<div id="legend" data-dojo-type="dijit/layout/ContentPane" 
        data-dojo-props="region:'top'"></div>
      <div id="header" data-dojo-type="dijit/layout/ContentPane" 
        data-dojo-props="region:'top'">
        <div id="featureCount" style="margin:5px;"><strong>1. Select a station on the map</strong></div>
        <div id="pager" style="display:none;"> 
          <a href='javascript:void(0);' id ="previous" class='nav' style="text-decoration: none;">
              &lt; Prev
          </a>   
          <a href='javascript:void(0);' id="next" class='nav'  style="text-decoration: none;">
              Next &gt;
          </a>
        </div>
      </div>
       
    </div>
    <!-- end left content --> 
    <div id="map" data-dojo-type="dijit/layout/ContentPane" data-dojo-props="region:'center'">
	 <div id="HomeButton"></div>
	</div>
 </div>
  
</body>

</html> 
